using Microsoft.EntityFrameworkCore;
using MarutiTrainingPortal.Data;
using MarutiTrainingPortal.Models;

namespace MarutiTrainingPortal.Repositories
{
    public class EventRepository : IEventRepository
    {
        private readonly ApplicationDbContext _context;

        public EventRepository(ApplicationDbContext context)
        {
            _context = context;
        }

        public async Task<(List<Event> Events, int TotalCount)> GetPagedAsync(int page, int pageSize, string? searchQuery, string filter)
        {
            var query = _context.Events
                .Where(e => !e.IsDeleted)
                .AsQueryable();

            // Apply search
            if (!string.IsNullOrWhiteSpace(searchQuery))
            {
                query = query.Where(e => 
                    e.Title.Contains(searchQuery) || 
                    (e.Location != null && e.Location.Contains(searchQuery)) ||
                    (e.Summary != null && e.Summary.Contains(searchQuery)));
            }

            // Apply filter
            var now = DateTime.UtcNow;
            query = filter switch
            {
                "Upcoming" => query.Where(e => e.StartDateUtc > now && e.Status != "Draft"),
                "Past" => query.Where(e => e.EndDateUtc < now),
                "Draft" => query.Where(e => e.Status == "Draft"),
                "Open" => query.Where(e => e.Status == "Open"),
                "Closed" => query.Where(e => e.Status == "Closed"),
                _ => query
            };

            var totalCount = await query.CountAsync();

            var events = await query
                .OrderByDescending(e => e.StartDateUtc)
                .Skip((page - 1) * pageSize)
                .Take(pageSize)
                .Include(e => e.Registrations.Where(r => !r.IsDeleted))
                .ToListAsync();

            return (events, totalCount);
        }

        public async Task<Event?> GetByIdAsync(int id, bool includeDeleted = false)
        {
            var query = _context.Events.AsQueryable();

            if (!includeDeleted)
            {
                query = query.Where(e => !e.IsDeleted);
            }

            return await query
                .Include(e => e.Registrations.Where(r => !r.IsDeleted))
                .FirstOrDefaultAsync(e => e.Id == id);
        }

        public async Task<Event> AddAsync(Event eventItem)
        {
            eventItem.CreatedAt = DateTime.UtcNow;
            eventItem.UpdatedAt = DateTime.UtcNow;
            _context.Events.Add(eventItem);
            await _context.SaveChangesAsync();
            return eventItem;
        }

        public async Task<Event> UpdateAsync(Event eventItem)
        {
            eventItem.UpdatedAt = DateTime.UtcNow;
            _context.Events.Update(eventItem);
            await _context.SaveChangesAsync();
            return eventItem;
        }

        public async Task<bool> SoftDeleteAsync(int id)
        {
            var eventItem = await GetByIdAsync(id);
            if (eventItem == null) return false;

            eventItem.IsDeleted = true;
            eventItem.UpdatedAt = DateTime.UtcNow;
            await _context.SaveChangesAsync();
            return true;
        }

        public async Task<List<EventRegistration>> GetRegistrationsAsync(int eventId)
        {
            return await _context.EventRegistrations
                .Where(r => r.EventId == eventId && !r.IsDeleted)
                .OrderByDescending(r => r.RegisteredAt)
                .ToListAsync();
        }

        public async Task<EventRegistration> AddRegistrationAsync(EventRegistration registration)
        {
            registration.RegisteredAt = DateTime.UtcNow;
            _context.EventRegistrations.Add(registration);
            await _context.SaveChangesAsync();
            return registration;
        }

        public async Task<int> GetRegistrationCountAsync(int eventId)
        {
            return await _context.EventRegistrations
                .Where(r => r.EventId == eventId && !r.IsDeleted)
                .CountAsync();
        }

        public async Task<bool> IncrementRegistrationCountAsync(int eventId)
        {
            var eventItem = await GetByIdAsync(eventId);
            if (eventItem == null) return false;

            eventItem.CurrentRegistrations++;
            eventItem.UpdatedAt = DateTime.UtcNow;
            await _context.SaveChangesAsync();
            return true;
        }
    }
}
