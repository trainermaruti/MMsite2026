@model List<MarutiTrainingPortal.Models.ContactMessage>

@{
    ViewData["Title"] = "Messages Inbox";
    Layout = "_ModernAdminLayout";
    var currentPage = ViewBag.CurrentPage;
    var totalPages = ViewBag.TotalPages;
    var searchQuery = ViewBag.SearchQuery ?? "";
    var filter = ViewBag.Filter ?? "All";
    var newCount = ViewBag.NewCount;
    var totalMessages = ViewBag.TotalMessages;
}

<link rel="stylesheet" href="~/css/admin-inbox.css" />

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert" style="background: var(--success-light); border: 1px solid var(--success); color: var(--success); border-radius: 12px; margin-bottom: 24px;">
        <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Modern Page Header -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;">
    <div>
        <h1 style="font-size: 32px; font-weight: 700; color: var(--text-primary); margin-bottom: 8px;">
            <i class="fas fa-inbox" style="color: var(--primary); margin-right: 12px;"></i>Messages Inbox
        </h1>
        <p style="color: var(--text-secondary); font-size: 15px; margin: 0;">Manage contact messages and inquiries</p>
    </div>
    <div style="display: flex; gap: 12px;">
        <a asp-area="Admin" asp-controller="Messages" asp-action="Export" asp-route-filter="@filter" class="modern-btn modern-btn-secondary">
            <i class="fas fa-download me-2"></i>Export CSV
        </a>
    </div>
</div>

<!-- Stats Bar -->
<div class="inbox-stats-bar">
    <a href="?filter=New&q=@searchQuery" class="inbox-stat-card @(filter == "New" ? "active" : "")">
        <div class="stat-icon new">
            <i class="fas fa-envelope"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">@newCount</div>
            <div class="stat-label">New Messages</div>
        </div>
    </a>
    
    <a href="?filter=All&q=@searchQuery" class="inbox-stat-card @(filter == "All" ? "active" : "")">
        <div class="stat-icon total">
            <i class="fas fa-inbox"></i>
        </div>
        <div class="stat-content">
            <div class="stat-value">@totalMessages</div>
            <div class="stat-label">Total Messages</div>
        </div>
    </a>
</div>

<!-- Search Bar -->
<div class="modern-card" style="margin-bottom: 24px; padding: 20px;">
    <form method="get" asp-area="Admin" asp-controller="Messages" asp-action="Index" style="display: flex; gap: 12px; align-items: center;">
        <input type="hidden" name="filter" value="@filter" />
        <div style="flex: 1; position: relative;">
            <i class="fas fa-search" style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 14px;"></i>
            <input type="text" 
                   name="q" 
                   value="@searchQuery" 
                   placeholder="Search by name, email, subject, or message..." 
                   class="modern-input" 
                   style="width: 100%; padding: 12px 16px 12px 44px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); font-size: 14px;">
        </div>
        <button type="submit" class="modern-btn modern-btn-primary">
            <i class="fas fa-search me-2"></i>Search
        </button>
        @if (!string.IsNullOrEmpty(searchQuery))
        {
            <a href="?filter=@filter" class="modern-btn modern-btn-secondary">
                <i class="fas fa-times me-2"></i>Clear
            </a>
        }
    </form>
</div>

<!-- Messages Table -->
<div class="modern-card" style="padding: 0; overflow: hidden;">
    @if (Model == null || Model.Count == 0)
    {
        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 48px; text-align: center;">
            <i class="fas fa-inbox" style="font-size: 64px; color: var(--text-muted); margin-bottom: 16px;"></i>
            <h3 style="color: var(--text-secondary); margin-bottom: 8px;">No messages found</h3>
            <p style="color: var(--text-muted); margin-bottom: 24px;">
                @if (!string.IsNullOrEmpty(searchQuery))
                {
                    <text>No messages match your search criteria.</text>
                }
                else if (filter == "New")
                {
                    <text>You have no new messages.</text>
                }
                else
                {
                    <text>No messages have been received yet.</text>
                }
            </p>
        </div>
    }
    else
    {
        <div class="inbox-table-wrapper">
            <table class="inbox-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>Sender</th>
                        <th>Subject</th>
                        <th style="width: 180px;">Received</th>
                        <th style="width: 140px; text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody id="messagesTableBody">
                    @foreach (var message in Model)
                    {
                        <tr class="inbox-row @(!message.IsRead ? "unread" : "")" data-message-id="@message.Id">
                            <td>
                                @if (!message.IsRead)
                                {
                                    <div class="unread-dot"></div>
                                }
                            </td>
                            <td>
                                <div class="sender-cell">
                                    <div class="sender-name">@message.Name</div>
                                    <div class="sender-email">@message.Email</div>
                                </div>
                            </td>
                            <td>
                                <div class="subject-cell" title="@message.Subject">
                                    @message.Subject
                                </div>
                            </td>
                            <td>
                                <div class="date-cell">
                                    @message.CreatedDate.ToString("MMM dd, yyyy")
                                    <span class="time-text">@message.CreatedDate.ToString("h:mm tt")</span>
                                </div>
                            </td>
                            <td style="text-align: right;">
                                <button type="button" 
                                        class="inbox-action-btn view-btn" 
                                        onclick="viewMessage(@message.Id)"
                                        title="View message">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" 
                                        class="inbox-action-btn delete-btn" 
                                        onclick="deleteMessage(@message.Id)"
                                        title="Delete message">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (totalPages > 1)
        {
            <div class="pagination-wrapper">
                <div class="pagination">
                    @if (currentPage > 1)
                    {
                        <a href="?page=@(currentPage - 1)&filter=@filter&q=@searchQuery" class="pagination-btn">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                    }
                    
                    @for (int i = 1; i <= totalPages; i++)
                    {
                        if (i == 1 || i == totalPages || (i >= currentPage - 2 && i <= currentPage + 2))
                        {
                            <a href="?page=@i&filter=@filter&q=@searchQuery" 
                               class="pagination-btn @(i == currentPage ? "active" : "")">
                                @i
                            </a>
                        }
                        else if (i == currentPage - 3 || i == currentPage + 3)
                        {
                            <span class="pagination-ellipsis">...</span>
                        }
                    }
                    
                    @if (currentPage < totalPages)
                    {
                        <a href="?page=@(currentPage + 1)&filter=@filter&q=@searchQuery" class="pagination-btn">
                            <i class="fas fa-chevron-right"></i>
                        </a>
                    }
                </div>
                <div class="pagination-info">
                    Page @currentPage of @totalPages
                </div>
            </div>
        }
    }
</div>

<!-- Message Modal -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background: var(--bg-secondary); border: 1px solid var(--border-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title" id="messageModalLabel" style="color: var(--text-primary); font-weight: 600;">
                    <i class="fas fa-envelope-open-text me-2" style="color: var(--primary);"></i>
                    <span id="modalSubject">Message Details</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 24px;">
                <!-- Message metadata -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="message-meta-item">
                            <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">From</label>
                            <div id="modalName" style="color: var(--text-primary); font-weight: 500; font-size: 15px;"></div>
                            <div id="modalEmail" style="color: var(--text-secondary); font-size: 14px; margin-top: 2px;"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="message-meta-item">
                            <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Phone</label>
                            <div id="modalPhone" style="color: var(--text-primary); font-weight: 500; font-size: 15px;"></div>
                        </div>
                        <div class="message-meta-item mt-3">
                            <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Received</label>
                            <div id="modalDate" style="color: var(--text-primary); font-weight: 500; font-size: 15px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Message content -->
                <div class="message-content-wrapper">
                    <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block;">Message</label>
                    <div id="modalMessage" class="message-content"></div>
                </div>

                <!-- Event info if applicable -->
                <div id="eventInfoSection" style="display: none; margin-top: 20px;">
                    <div style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                        <label style="color: var(--text-muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; display: block;">Related Event</label>
                        <div id="modalEventTitle" style="color: var(--primary); font-weight: 500;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color); gap: 8px;">
                <button type="button" id="emailReplyBtn" class="modern-btn modern-btn-primary" style="margin-right: auto;">
                    <i class="fas fa-envelope me-2"></i>Reply via Email
                </button>
                <button type="button" id="whatsappReplyBtn" class="modern-btn modern-btn-success" style="display: none;">
                    <i class="fab fa-whatsapp me-2"></i>Reply via WhatsApp
                </button>
                <button type="button" id="markUnreadBtn" class="modern-btn modern-btn-secondary" onclick="toggleReadStatus()">
                    <i class="fas fa-envelope me-2"></i>Mark as Unread
                </button>
                <button type="button" class="modern-btn modern-btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--bg-secondary); border: 1px solid var(--border-color);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                <h5 class="modal-title" id="deleteModalLabel" style="color: var(--text-primary);">
                    <i class="fas fa-exclamation-triangle me-2" style="color: #ef4444;"></i>Confirm Delete
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="color: var(--text-secondary);">
                Are you sure you want to delete this message? This action cannot be undone.
            </div>
            <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                <button type="button" class="modern-btn modern-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="modern-btn modern-btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash me-2"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentMessageId = null;
        let currentMessageEmail = '';
        let currentMessagePhone = '';
        let currentMessageName = '';
        let currentMessageSubject = '';

        // View message - opens modal and marks as read
        async function viewMessage(id) {
            currentMessageId = id;
            
            try {
                const response = await fetch(`/Admin/Messages/GetMessage/${id}`);
                const data = await response.json();
                
                if (data.success) {
                    // Populate modal
                    document.getElementById('modalSubject').textContent = data.subject;
                    document.getElementById('modalName').textContent = data.name;
                    document.getElementById('modalEmail').textContent = data.email;
                    document.getElementById('modalPhone').textContent = data.phoneNumber || 'Not provided';
                    document.getElementById('modalDate').textContent = data.createdDate;
                    document.getElementById('modalMessage').textContent = data.message;
                    
                    // Store for reply actions
                    currentMessageEmail = data.email;
                    currentMessagePhone = data.phoneNumber;
                    currentMessageName = data.name;
                    currentMessageSubject = data.subject;
                    
                    // Event info
                    if (data.eventId && data.eventTitle) {
                        document.getElementById('eventInfoSection').style.display = 'block';
                        document.getElementById('modalEventTitle').textContent = data.eventTitle;
                    } else {
                        document.getElementById('eventInfoSection').style.display = 'none';
                    }
                    
                    // WhatsApp button
                    if (data.phoneNumber) {
                        document.getElementById('whatsappReplyBtn').style.display = 'inline-block';
                    } else {
                        document.getElementById('whatsappReplyBtn').style.display = 'none';
                    }
                    
                    // Update row UI to mark as read
                    const row = document.querySelector(`tr[data-message-id="${id}"]`);
                    if (row && row.classList.contains('unread')) {
                        row.classList.remove('unread');
                        const dot = row.querySelector('.unread-dot');
                        if (dot) dot.remove();
                        
                        // Update stats
                        updateStats(-1);
                    }
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('messageModal'));
                    modal.show();
                } else {
                    alert('Failed to load message: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error fetching message:', error);
                alert('Failed to load message. Please try again.');
            }
        }

        // Toggle read/unread status
        async function toggleReadStatus() {
            if (!currentMessageId) return;
            
            const row = document.querySelector(`tr[data-message-id="${currentMessageId}"]`);
            const isCurrentlyRead = !row.classList.contains('unread');
            const newReadStatus = !isCurrentlyRead;
            
            try {
                const response = await fetch(`/Admin/Messages/MarkAsRead/${currentMessageId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify({ isRead: newReadStatus })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update UI
                    if (newReadStatus) {
                        row.classList.remove('unread');
                        const dot = row.querySelector('.unread-dot');
                        if (dot) dot.remove();
                        updateStats(-1);
                    } else {
                        row.classList.add('unread');
                        const firstTd = row.querySelector('td:first-child');
                        firstTd.innerHTML = '<div class="unread-dot"></div>';
                        updateStats(1);
                    }
                    
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
                } else {
                    alert('Failed to update message status');
                }
            } catch (error) {
                console.error('Error updating message status:', error);
                alert('Failed to update message status. Please try again.');
            }
        }

        // Delete message
        let messageToDelete = null;

        function deleteMessage(id) {
            messageToDelete = id;
            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        async function confirmDelete() {
            if (!messageToDelete) return;
            
            try {
                const response = await fetch(`/Admin/Messages/Delete/${messageToDelete}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Remove row from table
                    const row = document.querySelector(`tr[data-message-id="${messageToDelete}"]`);
                    if (row) {
                        const wasUnread = row.classList.contains('unread');
                        row.remove();
                        
                        if (wasUnread) {
                            updateStats(-1);
                        }
                        updateStats(0, -1); // Decrease total count
                    }
                    
                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                    
                    // Show success message
                    showToast('Message deleted successfully', 'success');
                } else {
                    alert('Failed to delete message');
                }
            } catch (error) {
                console.error('Error deleting message:', error);
                alert('Failed to delete message. Please try again.');
            }
        }

        // Email reply
        document.getElementById('emailReplyBtn').addEventListener('click', function() {
            const subject = encodeURIComponent(`Re: ${currentMessageSubject}`);
            const body = encodeURIComponent(`\n\n--- Original message from ${currentMessageName} ---\n`);
            window.location.href = `mailto:${currentMessageEmail}?subject=${subject}&body=${body}`;
        });

        // WhatsApp reply
        document.getElementById('whatsappReplyBtn').addEventListener('click', function() {
            if (currentMessagePhone) {
                const phone = currentMessagePhone.replace(/[^0-9]/g, '');
                const message = encodeURIComponent(`Hello ${currentMessageName}, regarding your inquiry...`);
                window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
            }
        });

        // Update stats counters
        function updateStats(newDelta = 0, totalDelta = 0) {
            const newCountEl = document.querySelector('.inbox-stat-card .stat-value');
            if (newCountEl && newDelta !== 0) {
                const currentNew = parseInt(newCountEl.textContent);
                newCountEl.textContent = Math.max(0, currentNew + newDelta);
            }
            
            if (totalDelta !== 0) {
                const totalCountEls = document.querySelectorAll('.inbox-stat-card .stat-value');
                if (totalCountEls[1]) {
                    const currentTotal = parseInt(totalCountEls[1].textContent);
                    totalCountEls[1].textContent = Math.max(0, currentTotal + totalDelta);
                }
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            // Simple toast - you can enhance this with a library
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '9999';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    </script>
}
