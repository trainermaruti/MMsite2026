@{
    ViewData["Title"] = "Message Cleanup Management";
    var expiredCount = (int)(ViewBag.ExpiredCount ?? 0);
    var expiringMessages = ViewBag.ExpiringMessages as List<MarutiTrainingPortal.Models.ContactMessage> ?? new List<MarutiTrainingPortal.Models.ContactMessage>();
}

<div class="container-fluid mt-5">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 d-flex align-items-center">
                <i class="fas fa-trash-alt me-3"></i>
                Message Cleanup Management
            </h1>
            <p class="text-muted">Manage automatic 28-day message retention policy</p>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row mb-5">
        <!-- Expired Messages Card -->
        <div class="col-md-6 mb-3">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-times me-2"></i>
                        Ready to Delete (28+ days old)
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        <strong class="display-4 text-danger">@expiredCount</strong>
                        <span class="text-muted">message(s)</span>
                    </p>
                    <p class="text-muted small">Messages older than 28 days that are ready for soft-deletion</p>
                    
                    <form method="post" action="/Admin/Messages/DeleteExpired" class="mt-3">
                        @Html.AntiForgeryToken()
                        <button type="submit" class="btn btn-danger" @(expiredCount == 0 ? "disabled" : "")>
                            <i class="fas fa-trash me-2"></i>
                            Delete Expired Messages (@expiredCount)
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Expiring Messages Card -->
        <div class="col-md-6 mb-3">
            <div class="card border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Expiring Soon (21+ days old)
                    </h5>
                </div>
                <div class="card-body">
                    <p class="card-text">
                        <strong class="display-4 text-warning">@expiringMessages.Count</strong>
                        <span class="text-muted">message(s)</span>
                    </p>
                    <p class="text-muted small">Messages older than 21 days that will be deleted in 7 days</p>
                    <small class="d-block text-muted mt-2">
                        <i class="fas fa-info-circle me-1"></i>
                        Auto-cleanup runs daily at 2:00 AM UTC
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Expiring Messages Table -->
    @if (expiringMessages.Count > 0)
    {
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">Messages Expiring Soon (21+ days old)</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>From</th>
                            <th>Email</th>
                            <th>Subject</th>
                            <th>Submitted</th>
                            <th>Days Old</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var msg in expiringMessages.OrderBy(m => m.CreatedDate).Take(50))
                        {
                            var daysOld = (int)(DateTime.UtcNow - msg.CreatedDate).TotalDays;
                            <tr class="@(daysOld >= 28 ? "table-danger" : daysOld >= 21 ? "table-warning" : "")">
                                <td>
                                    <strong>@msg.Name</strong>
                                </td>
                                <td>
                                    <a href="mailto:@msg.Email">@msg.Email</a>
                                </td>
                                <td>
                                    @msg.Subject
                                </td>
                                <td>
                                    <small class="text-muted">@msg.CreatedDate.ToString("yyyy-MM-dd HH:mm")</small>
                                </td>
                                <td>
                                    <span class="badge @(daysOld >= 28 ? "bg-danger" : daysOld >= 21 ? "bg-warning" : "bg-info")">
                                        @daysOld days
                                    </span>
                                </td>
                                <td>
                                    <form method="post" action="/Admin/Messages/DeleteById" style="display:inline;">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="id" value="@msg.Id" />
                                        <button type="submit" class="btn btn-sm btn-danger" title="Delete now">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            @if (expiringMessages.Count > 50)
            {
                <div class="card-footer text-muted small">
                    Showing 50 of @expiringMessages.Count expiring messages
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No messages are expiring soon. All messages are less than 21 days old.
        </div>
    }

    <!-- Information Section -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card bg-light">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="fas fa-question-circle me-2"></i>
                        How Message Retention Works
                    </h5>
                    <ul class="mb-0">
                        <li><strong>Creation:</strong> Messages submitted with IsDeleted=false</li>
                        <li><strong>Visibility:</strong> All non-deleted messages appear in admin portal</li>
                        <li><strong>Auto-Cleanup:</strong> Messages older than 28 days are automatically soft-deleted daily at 2:00 AM UTC</li>
                        <li><strong>Soft-Delete:</strong> IsDeleted flag set to true (data preserved for archives)</li>
                        <li><strong>Manual Delete:</strong> Admins can manually delete messages anytime</li>
                        <li><strong>Query Filter:</strong> Soft-deleted messages hidden from admin portal automatically</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .table-danger {
        background-color: rgba(220, 53, 69, 0.1) !important;
    }

    .table-warning {
        background-color: rgba(255, 193, 7, 0.1) !important;
    }

    .badge {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem;
    }
</style>
